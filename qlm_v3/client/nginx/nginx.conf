# ========== Gzip 壓縮優化 (綜合版) ==========
gzip on;
gzip_vary on; # 回應頭中包含 "Vary: Accept-Encoding"，讓代理伺服器正確處理快取
gzip_proxied any; # 代理任何請求
gzip_comp_level 6; # 壓縮等級 (1-9)，6是一個很好的平衡點
gzip_buffers 16 8k;
gzip_http_version 1.1;
gzip_min_length 1k; # 檔案小於 1KB 不進行壓縮，避免開銷
gzip_disable "msie6"; # 不對古老的 IE6 進行壓縮
# 要進行壓縮的檔案類型
gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/x-javascript
    application/json
    application/xml
    application/rss+xml
    image/svg+xml;


# 主伺服器配置
server {
    listen 80;
    # 接受任何主機名的請求，也可以寫 server_name localhost;
    server_name  _;

    # 網站根目錄
    root   /usr/share/nginx/html;
    index  index.html;

    # ========== 安全性優化 ==========
    # 隱藏 Nginx 版本號
    server_tokens off;
    # 限制客戶端請求 body 的大小，防止惡意的大請求
    client_max_body_size 10m;


    # ========== 靜態資源快取設定 (最優先匹配) ==========
    # 對圖片、字體、CSS、JS 等不常變動的檔案設置長期快取
    # 如果你的檔名包含 hash (如 main.a1b2c3d4.js)，可以設為 1y (一年)
    location ~* \.(?:css|js|ico|svg|jpe?g|png|gif|woff2?|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }


    # ========== API Proxy ==========
    # Forward all requests starting with /api/ to the server service
    location ~ ^/(api|data)/ {
        client_max_body_size 10m;

        proxy_pass http://server:3000;
        
        # --- Forward necessary headers ---
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade; # 支援 WebSocket
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        
        # --- Allow backend to retrieve real cilent information ---
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ========== SPA (Single Page Application) support (Final Match) ==========
    # Nginx searches sequentially for a file ($uri), then a directory ($uri/), and if neither is found, it returns /index.html
    location / {
        try_files $uri $uri/ /index.html;
    }
}